[
  {
    "type": "effect_on_condition",
    "id": "EOC_radiosphere_create_world",
    "//": "Prepares radiosphere world.",
    "eoc_type": "EVENT",
    "required_event": "game_avatar_new",
    "effect": [
      {
        "create_world": {
          "world_prefix": "radiosphere",
          "region_type": "radiosphere"
        }
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_radiosphere_countdown",
    "//": "countdown.",
    "recurrence": "10 seconds",
    "condition": {
      "math": [
        "u_radiosphere_time_until_teleport",
        ">=",
        "0"
      ]
    },
    "deactivate_condition": {
      "math": [
        "u_radiosphere_time_until_teleport",
        "<=",
        "-999"
      ]
    },
    "effect": [
      {
        "u_location_variable": {
          "context_val": "ladder_check"
        }
      },
      {
        "if": {
          "math": [
            "u_radiosphere_time_until_teleport",
            "<=",
            "0"
          ]
        },
        "then": [
          {
            "if": {
              "map_terrain_id": "t_ladder_down",
              "loc": {
                "context_val": "ladder_check"
              }
            },
            "then": [
              {
                "run_eocs": [
                  "EOC_radiosphere_teleport"
                ]
              },
              {
                "math": [
                  "u_radiosphere_time_until_teleport",
                  "=",
                  "-999"
                ]
              }
            ]
          },
          {
            "math": [
              "u_radiosphere_time_until_teleport",
              "=",
              "max(rand(130),20)"
            ]
          }
        ]
      },
      {
        "math": [
          "u_radiosphere_time_until_teleport",
          "-=",
          "1"
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_radiosphere_enter_exit",
    "//": "Entering/Exiting the radiosphere.",
    "eoc_type": "EVENT",
    "required_event": "avatar_enters_omt",
    "condition": {
      "or": [
        {
          "u_at_om_location": "radio_tower_top"
        },
        {
          "u_at_om_location": "radio_tower_top_liminal"
        },
        {
          "u_at_om_location": "wasp_tower_top"
        }
      ]
    },
    "effect": [
      {
        "math": [
          "u_radiosphere_time_until_teleport",
          "=",
          "max(rand(130),20)"
        ]
      },
      {
        "u_add_trait": "mut_radiosphere_inhabitance"
      },
      {
        "u_lose_trait": "mut_radiosphere_inhabitance"
      },
      {
        "run_eocs": "EOC_radiosphere_countdown"
      }
    ],
    "false_effect": [
      {
        "math": [
          "u_radiosphere_time_until_teleport",
          "=",
          "-999"
        ]
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_radiosphere_light_deactivate",
    "//": "envelops the world in sun :).",
    "global": true,
    "recurrence": "30 seconds",
    "condition": {
      "not": {
        "u_in_world": "radiosphere"
      }
    },
    "deactivate_condition": {
      "not": {
        "u_in_world": "radiosphere"
      }
    },
    "effect": [
      {
        "alter_timed_events": "radiosphere_lights_off"
      }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_radiosphere_teleport",
    "//": "shifts the character to radiosphere world or back",
    "effect": [
      {
        "if": {
          "u_in_world": ""
        },
        "then": [
          {
            "u_go_to_world": "radiosphere"
          },
          {
            "u_location_variable": {
              "context_val": "nearest_floor"
            },
            "terrain": "t_ladder_down",
            "target_max_radius": 60,
            "min_radius": 0,
            "max_radius": 0
          },
          {
            "if": {
              "math": [
                "has_var(_nearest_floor)"
              ]
            },
            "then": {
              "u_teleport": {
                "context_val": "nearest_floor"
              }
            }
          },
          "next_weather",
          {
            "custom_light_level": 255,
            "length": "9999 days",
            "key": "radiosphere_lights_off"
          },
          {
            "run_eocs": [
              "EOC_radiosphere_light_deactivate"
            ]
          },
          {
            "u_message": "you feel a electrostatic buzz in the air.",
            "interrupt_type": "eoc",
            "popup": true,
            "popup_w_interrupt_query": true
          }
        ],
        "else": [
          {
            "if": {
              "u_in_world": "radiosphere"
            },
            "then": [
              {
                "u_go_to_world": "default"
              },
              {
                "u_location_variable": {
                  "context_val": "nearest_radio_tower_floor"
                },
                "target_params": {
                  "om_terrain": "radio_tower_top",
                  "om_terrain_match_type": "TYPE",
                  "search_range": 1200,
                  "z": 6
                },
                "terrain": "t_ladder_down",
                "target_max_radius": 60,
                "min_radius": 0,
                "max_radius": 0
              },
              {
                "u_location_variable": {
                  "context_val": "ground"
                },
                "z_override": true,
                "z_adjust": 0
              },
              {
                "if": {
                  "math": [
                    "has_var(_nearest_radio_tower_floor)"
                  ]
                },
                "then": {
                  "u_teleport": {
                    "context_val": "nearest_radio_tower_floor"
                  },
                  "fail_message": "",
                  "success_message": ""
                },
                "else": {
                  "u_teleport": {
                    "context_val": "ground"
                  },
                  "fail_message": "",
                  "success_message": ""
                }
              },
              {
                "u_message": "vague normality surrounds you, you're back home.",
                "interrupt_type": "eoc",
                "popup": true,
                "popup_w_interrupt_query": true
              },
              {
                "alter_timed_events": "radiosphere_lights_off"
              }
            ]
          }
        ]
      }
    ]
  }
]
